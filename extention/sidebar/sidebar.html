<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Sidebar</title>
  <style>
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0f172a;color:#e2e8f0}
    header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#111827}
    .container{padding:10px;height:calc(100vh - 44px);overflow:auto}
    textarea{width:100%;min-height:90px;background:#0b1220;color:#e2e8f0;border:1px solid #334155;border-radius:6px;padding:8px}
    button{background:#4F46E5;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .row{display:flex;gap:8px;margin-top:8px}
  </style>
  <script defer src="../common/messaging.js"></script>
  <script defer src="../common/aiService.js"></script>
  <script defer src="../common/answerFormatter.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" />
  <script defer>
    let lastSubject = 'auto';
    window.addEventListener('message', async (ev) => {
      if (!ev?.data || ev.data.source !== 'aiqs') return;
      const container = document.getElementById('out');
      if (ev.data.kind === 'solve') {
        document.getElementById('q').value = ev.data.text || '';
        document.getElementById('solve').click();
      } else if (ev.data.kind === 'screenshot') {
        document.getElementById('status').textContent = 'Running OCR...';
        try {
          const { data } = await Tesseract.recognize(ev.data.dataUrl, 'eng');
          document.getElementById('q').value = data.text.trim();
          document.getElementById('solve').click();
        } catch (e){
          console.error(e);
          document.getElementById('status').textContent = 'OCR failed';
        }
      }
    });

    async function doSolve(){
      const q = document.getElementById('q').value.trim();
      const subject = document.getElementById('subject').value;
      if (!q) return;
      setStatus('Solving...');
      const raw = await window.aiService.solveQuestion(q, subject === 'programming' ? 'coding' : subject, subject);
      const html = window.answerFormatter.render(raw, subject);
      const out = document.getElementById('out');
      out.innerHTML = html;
      out.querySelectorAll('pre code').forEach((block)=>hljs.highlightElement(block));
      setStatus('Done');
    }
    function setStatus(s){ document.getElementById('status').textContent = s; }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('solve').addEventListener('click', doSolve);
    });
  </script>
</head>
<body>
  <header>
    <div>AI Question Solver</div>
    <div id="status">Ready</div>
  </header>
  <div class="container">
    <textarea id="q" placeholder="Ask a question or wait for selection..."></textarea>
    <div class="row">
      <select id="subject">
        <option value="auto">Auto</option>
        <option value="mathematics">Mathematics</option>
        <option value="programming">Programming</option>
        <option value="science">Science</option>
        <option value="writing">Writing</option>
      </select>
      <button id="solve">Solve</button>
    </div>
    <div id="out" style="margin-top:10px"></div>
  </div>
</body>
</html>


